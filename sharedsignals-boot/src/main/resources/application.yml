# ==============================================================================
#  SHARED SIGNALS TRANSMITTER - MASTER CONFIGURATION
# ==============================================================================
#  This configuration controls the behavior of the CAEP/RISC Transmitter.
#
#  Structure:
#  1. Spring Boot Core (Server, DB, Security)
#  2. OpenAPI / Swagger Documentation
#  3. Shared Signals Domain:
#     - Identity & Security
#     - Rate Limiting
#     - Data Retention (Lifecycle)
#     - Feature Flags (Toggles)
#     - Scheduler (Timing)
# ==============================================================================

server:
  port: 8080

spring:
  application:
    name: sharedsignals-transmitter

  # --- DATABASE (H2 for Development / PostgreSQL for Production) ---
  datasource:
    url: jdbc:h2:mem:sharedsignals;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driverClassName: org.h2.Driver
    username: sa
    password: password
  h2:
    console:
      enabled: true
      path: /h2-console

  # --- JPA / HIBERNATE ---
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      # 'update' ensures tables (including 'shedlock' and 'ssf_push_queue') are created automatically
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        format_sql: true

  # --- OAUTH2 RESOURCE SERVER (Security) ---
  security:
    oauth2:
      resourceserver:
        jwt:
          # URL to fetch public keys for validating access tokens (from your IdP)
          # Example: https://auth.example.com/.well-known/jwks.json
          jwk-set-uri: ${OAUTH2_JWKS_URI:http://localhost:8080/.well-known/jwks.json}

# ==============================================================================
#  OPENAPI / SWAGGER UI CONFIGURATION
# ==============================================================================
springdoc:
  api-docs:
    # Path to the raw JSON OpenAPI spec (useful for client generation tools)
    path: /api-docs
  swagger-ui:
    # URL path to access the Swagger UI in browser
    path: /swagger-ui.html

    # Sort endpoints by HTTP Method (GET -> POST -> PUT -> DELETE)
    operations-sorter: method

    # Sort Tags (Controllers) Alphabetically
    tags-sorter: alpha

    # Visual State: 'none' (collapsed), 'list' (expanded), 'full' (fully expanded)
    doc-expansion: none

    # Enable "Try it out" button by default?
    try-it-out-enabled: true

    # Validates spec against swagger.io online validator (disable for localhost/intranet)
    validator-url: none

# ==============================================================================
#  DOMAIN SETTINGS
# ==============================================================================
sharedsignals:

  # ----------------------------------------------------------------------------
  # 1. CORE IDENTITY
  # ----------------------------------------------------------------------------
  # The base URL of this Transmitter. Used in the 'iss' claim of SET tokens.
  # MUST match the URL where .well-known/ssf-configuration is hosted.
  issuer: ${SSF_ISSUER_URL:http://localhost:8080}

  # ----------------------------------------------------------------------------
  # 2. CRYPTOGRAPHY & SECURITY
  # ----------------------------------------------------------------------------
  security:
    # [REQUIRED] RSA Private Key (PKCS#8 Base64 Encoded) for signing SETs.
    # If blank, an ephemeral key is generated (NOT FOR PRODUCTION).
    signing-key: ${SSF_SIGNING_KEY:}

    # The Key ID (kid) to include in the JWT header.
    signing-key-id: ${SSF_SIGNING_KEY_ID:ssf-key-1}

  # ----------------------------------------------------------------------------
  # 3. RATE LIMITING (Token Bucket)
  # ----------------------------------------------------------------------------
  ratelimit:
    # Master switch to enable/disable rate limiting globally.
    enabled: true

    # Bucket Capacity (Burst Limit).
    # Maximum number of requests a client can make instantly.
    capacity: 1000

    # Refill Rate: How many tokens are added back to the bucket...
    refill-tokens: 500

    # ...per this duration (in seconds).
    # Example: 500 tokens per 60 seconds.
    refill-duration-seconds: 60

  # ----------------------------------------------------------------------------
  # 4. DATA RETENTION POLICIES (Time-to-Live)
  # ----------------------------------------------------------------------------
  retention:
    # [Seconds] How long a removed subject stays in 'soft delete' state (Anti-Probing).
    # SSF Spec Section 9.3: Prevents attackers from probing if a subject exists.
    # Default: 7 Days (604800s).
    subject-grace-period-seconds: 604800

    # [Days] How long to keep acknowledged poll events in DB before hard delete.
    # Used for audit trails or debugging.
    # Default: 7 Days.
    acknowledged-event-history-days: 7

  # ----------------------------------------------------------------------------
  # 5. DEFAULTS & LIMITS (Compliance)
  # ----------------------------------------------------------------------------
  defaults:
    # [Seconds] Inactivity Timeout (SSF Spec 8.1.1).
    # If a receiver doesn't poll or interact for this long, the stream is paused.
    # Default: 30 days (2592000 seconds).
    inactivity-timeout: 2592000

    # Max allowed length for stream descriptions (Input Validation).
    max-description-length: 255

    # Verification event request frequency in second
    min-verification-interval: 1

  # ----------------------------------------------------------------------------
  # 6. FEATURE FLAGS (Toggles)
  # ----------------------------------------------------------------------------
  features:
    # [Config] Allow one receiver (client_id) to create multiple streams?
    # SSF Spec recommends allowing this, but simple implementations may restrict it.
    multi-stream-per-receiver: false

    # [Worker] Enable Push Delivery System?
    # If false, events will queue up but won't be sent (unless polled).
    push-delivery: true

    # [Worker] Enable Stream Inactivity Monitoring?
    # If true, pauses streams that haven't been active for 'inactivity-timeout'.
    stream-monitoring: true

    # [Maintenance] Database Cleanup Jobs
    maintenance:
      # Delete old acknowledged events from DB? (Uses retention.acknowledged-event-history-days)
      events: true
      # Delete expired removed subjects from DB? (Uses retention.subject-grace-period-seconds)
      subjects: true

  # ----------------------------------------------------------------------------
  # 7. SCHEDULER FREQUENCIES (Timing)
  # ----------------------------------------------------------------------------
  scheduler:
    # [Milliseconds] How often to check the Outbox for pending Push events.
    # Default: 1000ms (1 second). Lower = lower latency, higher load.
    push-delivery-interval: 1000

    # [Milliseconds] How often to check for inactive streams.
    # Default: 5 minutes.
    inactivity-check-interval: 300000
    inactivity-check-initial-delay: 60000

    # [Milliseconds] How often to clean up expired subject grace periods.
    # Default: Daily (86400000 ms).
    grace-period-cleanup-interval: 86400000
    grace-period-cleanup-initial-delay: 3600000

    # [CRON] When to delete old acknowledged events from the database.
    # Default: Every day at 02:00 AM.
    event-cleanup-cron: "0 0 2 * * ?"

# ==============================================================================
# LOGGING CONFIGURATION
# ==============================================================================
logging:
  level:
    root: INFO
    # App Logs
    com.nevzatcirak.sharedsignals: DEBUG
    # Security Logs (Auth failures, etc.)
    org.springframework.security: INFO